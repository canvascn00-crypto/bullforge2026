<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullforge | The Future isn't Just Bullish. It's Bullforge.</title>

  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Â≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet" />

  <style>
    :root {
      --gold-primary: #FFD700;
      --gold-secondary: #FFA500;
      --dark-bg: #050505;
      --dark-card: #0F0F0F;
      --dark-border: #1A1A1A;
      --text-white: #FFFFFF;
      --text-gray: #A0A0A0;
      --text-muted: #666666;
      --danger: #FF4444;
      --success: #00C853;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    html { scroll-behavior: smooth; }
    body { background-color: var(--dark-bg); color: var(--text-white); line-height: 1.6; overflow-x: hidden; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    .navbar {
      position: fixed; top: 0; left: 0; width: 100%; z-index: 999;
      padding: 16px 0; background: rgba(5, 5, 5, 0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--dark-border);
    }
    .navbar-content { display: flex; justify-content: space-between; align-items: center; }
    .navbar-logo { font-size: 26px; font-weight: 900; color: var(--gold-primary); letter-spacing: -0.5px; }
    .navbar-links { display: flex; gap: 18px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .navbar-links a { color: var(--text-gray); text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
    .navbar-links a:hover { color: var(--gold-primary); }

    #walletConnectBtn {
      padding: 10px 18px;
      background: var(--gold-primary);
      color: var(--dark-bg);
      border: none;
      border-radius: 50px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    #walletConnectBtn:hover:not(:disabled) { box-shadow: 0 0 18px rgba(255, 215, 0, 0.35); transform: translateY(-1px); }
    #walletConnectBtn:disabled { opacity: 0.65; cursor: not-allowed; }

    #disconnectBtn {
      padding: 9px 14px;
      background: transparent;
      color: var(--gold-primary);
      border: 1px solid var(--gold-primary);
      border-radius: 50px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    #disconnectBtn:hover { background: rgba(255, 215, 0, 0.10); }

    .hero {
      min-height: 100vh;
      padding-top: 110px;
      display: flex;
      align-items: center;
      text-align: center;
      background: linear-gradient(180deg, #0A0500 0%, var(--dark-bg) 100%);
      position: relative;
      overflow: hidden;
    }
    .hero-bg-glow {
      position: absolute;
      top: -55%;
      left: 50%;
      transform: translateX(-50%);
      width: 1100px;
      height: 1100px;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 70%);
      z-index: 0;
    }
    .hero-content { position: relative; z-index: 1; width: 100%; }
    .hero-title {
      font-size: 56px;
      font-weight: 900;
      line-height: 1.12;
      margin-bottom: 14px;
      background: linear-gradient(180deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-slogan { font-size: 18px; color: var(--text-gray); margin-bottom: 28px; }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-top: 18px;
    }
    .stat-card {
      background: var(--dark-card);
      border: 1px solid var(--dark-border);
      border-radius: 12px;
      padding: 16px;
      text-align: left;
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 8px;
    }
    .stat-value { font-size: 20px; font-weight: 800; color: var(--gold-primary); }

    .countdown-wrapper { margin: 22px 0; }
    .countdown-title { font-size: 12px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .countdown-grid { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .countdown-box {
      background: var(--dark-card);
      border: 1px solid var(--gold-primary);
      border-radius: 12px;
      min-width: 92px;
      padding: 14px 8px;
    }
    .countdown-number { font-size: 32px; font-weight: 900; color: var(--gold-primary); line-height: 1; }
    .countdown-text { font-size: 11px; color: var(--text-gray); margin-top: 8px; text-transform: uppercase; }

    .progress-wrapper { width: 100%; margin: 18px 0 24px; }
    .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .progress-header span { font-size: 13px; color: var(--text-gray); }
    .progress-bar-container {
      width: 100%;
      height: 12px;
      background: var(--dark-card);
      border-radius: 100px;
      overflow: hidden;
      border: 1px solid var(--dark-border);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
      width: 0%;
      transition: width 0.8s ease;
      border-radius: 100px;
    }

    .buy-form-card {
      background: var(--dark-card);
      border: 1px solid var(--dark-border);
      border-radius: 16px;
      padding: 22px;
      max-width: 640px;
      margin: 0 auto;
      width: 100%;
      text-align: left;
    }
    .form-input-group { margin-bottom: 14px; }
    .form-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-gray);
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-input {
      width: 100%;
      padding: 14px;
      background: var(--dark-bg);
      border: 1px solid var(--dark-border);
      border-radius: 12px;
      color: var(--text-white);
      font-size: 16px;
      font-weight: 650;
      transition: border-color 0.2s ease;
    }
    .form-input:focus { outline: none; border-color: var(--gold-primary); }
    .token-estimate { font-size: 13px; color: var(--text-gray); margin: 10px 0 18px; }

    .buy-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
      color: var(--dark-bg);
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .buy-button:hover:not(:disabled) { box-shadow: 0 0 26px rgba(255, 215, 0, 0.35); transform: translateY(-1px); }
    .buy-button:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    .btn-secondary {
      width: 100%;
      padding: 13px;
      background: transparent;
      color: var(--gold-primary);
      border: 2px solid var(--gold-primary);
      border-radius: 12px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }
    .btn-secondary:hover:not(:disabled) { background: rgba(255, 215, 0, 0.10); }
    .btn-secondary:disabled { opacity: 0.55; cursor: not-allowed; }

    .section { padding: 80px 0; border-top: 1px solid var(--dark-border); }
    .section h2 { font-size: 34px; margin-bottom: 10px; }
    .section p { color: var(--text-gray); max-width: 900px; margin: 0 auto; text-align: center; }

    .notification {
      position: fixed;
      top: 90px;
      right: 16px;
      max-width: 420px;
      padding: 16px 18px;
      background: var(--dark-card);
      border: 1px solid var(--gold-primary);
      border-radius: 12px;
      z-index: 9999;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      transform: translateX(120%);
      transition: transform 0.25s ease;
    }
    .notification.show { transform: translateX(0); }
    .notification-title { font-weight: 800; margin-bottom: 6px; }
    .notification-desc { font-size: 13px; color: var(--text-gray); word-break: break-word; }

    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      border-top-color: var(--gold-primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 920px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .hero-title { font-size: 40px; }
    }
    @media (max-width: 520px) {
      .navbar-links a { display: none; }
      .hero-title { font-size: 34px; }
      .hero-slogan { font-size: 15px; }
      .notification { left: 12px; right: 12px; max-width: none; }
    }
  </style>
</head>

<body>
  <!-- ÈÄöÁü• -->
  <div id="notification" class="notification">
    <div class="notification-title" id="notificationTitle"></div>
    <div class="notification-desc" id="notificationDesc"></div>
  </div>

  <!-- È°∂ÈÉ®ÂØºËà™ -->
  <nav class="navbar">
    <div class="container navbar-content">
      <div class="navbar-logo">üêÇ BULLFORGE</div>
      <div class="navbar-links">
        <a href="#about">About</a>
        <a href="#faq">FAQ</a>
        <button id="walletConnectBtn">Connect Wallet</button>
        <button id="disconnectBtn" style="display:none;">Disconnect</button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-bg-glow"></div>
    <div class="container hero-content">
      <h1 class="hero-title">The Future isn't Just Bullish. It's Bullforge.</h1>
      <p class="hero-slogan">Click Connect Wallet ‚Üí choose wallet ‚Üí connect (bullzilla style).</p>

      <!-- È¢ÑÂîÆÊ†∏ÂøÉÊï∞ÊçÆ -->
      <div class="grid-4">
        <div class="stat-card">
          <div class="stat-label">Current Price</div>
          <div class="stat-value" id="currentPrice"><span class="loading-spinner"></span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Raised</div>
          <div class="stat-value" id="totalRaised"><span class="loading-spinner"></span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Current Stage</div>
          <div class="stat-value" id="currentStage"><span class="loading-spinner"></span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">1 BNB =</div>
          <div class="stat-value" id="tokenRate"><span class="loading-spinner"></span></div>
        </div>
      </div>

      <!-- ÂÄíËÆ°Êó∂ -->
      <div class="countdown-wrapper">
        <div class="countdown-title">PRESALE ENDS IN</div>
        <div class="countdown-grid">
          <div class="countdown-box">
            <div class="countdown-number" id="countdownDays">--</div>
            <div class="countdown-text">Days</div>
          </div>
          <div class="countdown-box">
            <div class="countdown-number" id="countdownHours">--</div>
            <div class="countdown-text">Hours</div>
          </div>
          <div class="countdown-box">
            <div class="countdown-number" id="countdownMinutes">--</div>
            <div class="countdown-text">Minutes</div>
          </div>
          <div class="countdown-box">
            <div class="countdown-number" id="countdownSeconds">--</div>
            <div class="countdown-text">Seconds</div>
          </div>
        </div>
      </div>

      <!-- ËøõÂ∫¶Êù° -->
      <div class="progress-wrapper">
        <div class="progress-header">
          <span>Presale Progress</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
      </div>

      <!-- Ë¥≠‰π∞Ê°Ü -->
      <div class="buy-form-card">
        <div class="form-input-group">
          <div class="form-label">
            <span>Amount (BNB)</span>
            <span>Balance: <span id="walletBalance">0.00</span> BNB</span>
          </div>
          <input type="number" class="form-input" id="bnbAmount" placeholder="0.0" step="0.01" min="0" />
        </div>

        <div class="form-input-group">
          <div class="form-label"><span>Slippage Tolerance</span></div>
          <input type="number" class="form-input" id="slippage" value="1.0" step="0.1" min="0.1" />
        </div>

        <div class="form-input-group">
          <div class="form-label"><span>Referrer Address (Optional)</span></div>
          <input type="text" class="form-input" id="referrerAddress" placeholder="0x..." />
        </div>

        <div class="token-estimate" id="tokenEstimate">Enter BNB amount to see estimated $BULL tokens</div>

        <button class="buy-button" id="buyButton" disabled>Connect Wallet To Buy</button>
        <button class="btn-secondary" id="claimButton" style="display:none;">Claim Your $BULL Tokens</button>
      </div>
    </div>
  </section>

  <section class="section" id="about">
    <div class="container">
      <h2 style="text-align:center;">About</h2>
      <p>Demo page with Reown AppKit wallet chooser modal + Ethers v5 contract calls.</p>
    </div>
  </section>

  <section class="section" id="faq">
    <div class="container">
      <h2 style="text-align:center;">FAQ</h2>
      <p>Â¶ÇÊûúËøûÊé•ÂêéÊåâÈíÆ‰∏çÂèòÔºåÊâìÂºÄÊéßÂà∂Âè∞ÁúãÊä•ÈîôÔºåÊääÁ¨¨‰∏ÄÊù°Á∫¢Ëâ≤ÈîôËØØÂèëÊàëÊàëÂ∏Æ‰Ω†‰øÆ„ÄÇ</p>
    </div>
  </section>
  <script type="module">
    // Reown AppKit (JavaScript + Ethers5Adapter) ‚Äî ÊñπÊ°àAÔºöÂºπ‚ÄúÈÄâÊã©Èí±ÂåÖ‚ÄùÂºπÁ™ó
    import { createAppKit } from "https://esm.sh/@reown/appkit@1.8.15";
    import { Ethers5Adapter } from "https://esm.sh/@reown/appkit-adapter-ethers5@1.8.4";
    import { bsc } from "https://esm.sh/@reown/appkit/networks@1.8.15";

    // ====== ‰Ω†ÁöÑÈÖçÁΩÆ ======
    const CONFIG = {
      CONTRACT_ADDRESS: "0x16D6c1a692AaC51a3821bA2903115d4600649F07",
      PROJECT_ID: "fe819ed06d9e5489f764fc7b1dae1c4e"
    };

    // Ê≥®ÊÑèÔºömetadata.url Âª∫ËÆÆ‰∏é‰Ω†ÈÉ®ÁΩ≤ÂüüÂêç‰∏ÄËá¥ÔºõËøôÈáåÁî® window.location.origin
    const metadata = {
      name: "Bullforge",
      description: "Bullforge Presale",
      url: window.location.origin,
      icons: ["https://avatars.githubusercontent.com/u/0?v=4"]
    };

    // ÂàõÂª∫ AppKit
    const modal = createAppKit({
      adapters: [new Ethers5Adapter()],
      projectId: CONFIG.PROJECT_ID,
      networks: [bsc],
      metadata
    });

    // ====== ABIÔºà‰Ω†ÂéüÊù•ÁöÑÔºâ======
    const CONTRACT_ABI = [
      "function totalRaised() view returns (uint256)",
      "function currentStage() view returns (uint256)",
      "function stageEndTime() view returns (uint256)",
      "function getCurrentPrice() view returns (uint256)",
      "function getRate() view returns (uint256)",
      "function hardCap() view returns (uint256)",
      "function contributed(address) view returns (uint256)",
      "function referralRewards(address) view returns (uint256)",
      "function totalSupply() view returns (uint256)",
      "function balanceOf(address) view returns (uint256)",
      "function buyTokens(address _referrer, uint256 _minTokensOut) payable",
      "function claimTokens() external",
      "event Buy(address indexed buyer, uint256 bnbAmount, uint256 tokenAmount, uint256 price, address indexed referrer)"
    ];

    // ====== UI ======
    const notif = document.getElementById("notification");
    const notifTitle = document.getElementById("notificationTitle");
    const notifDesc = document.getElementById("notificationDesc");

    const connectBtn = document.getElementById("walletConnectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    const buyButton = document.getElementById("buyButton");
    const claimButton = document.getElementById("claimButton");

    const bnbAmountInput = document.getElementById("bnbAmount");
    const slippageInput = document.getElementById("slippage");
    const referrerInput = document.getElementById("referrerAddress");
    const tokenEstimate = document.getElementById("tokenEstimate");
    const walletBalanceSpan = document.getElementById("walletBalance");

    const currentPriceSpan = document.getElementById("currentPrice");
    const totalRaisedSpan = document.getElementById("totalRaised");
    const currentStageSpan = document.getElementById("currentStage");
    const tokenRateSpan = document.getElementById("tokenRate");
    const totalSupplySpan = document.getElementById("totalSupplyDisplay");
    const progressPercent = document.getElementById("progressPercent");
    const progressBarFill = document.getElementById("progressBarFill");

    const daysSpan = document.getElementById("countdownDays");
    const hoursSpan = document.getElementById("countdownHours");
    const minutesSpan = document.getElementById("countdownMinutes");
    const secondsSpan = document.getElementById("countdownSeconds");

    // ====== Áä∂ÊÄÅ ======
    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let eip155Provider = null;

    let currentRate = 0;
    let totalRaisedBNB = 0;
    let hardcapBNB = 2000;
    let stageEndTimestamp = 0;
    let countdownInterval = null;

    function showNotification(title, desc, isError = false) {
      notifTitle.innerText = title;
      notifDesc.innerText = desc;
      notif.classList.add("show");
      notif.style.borderColor = isError ? "var(--danger)" : "var(--gold-primary)";
      setTimeout(() => notif.classList.remove("show"), 4500);
    }

    function shortAddr(a) {
      if (!a) return "";
      return a.slice(0, 6) + "..." + a.slice(-4);
    }

    function updateCountdown() {
      if (!stageEndTimestamp || stageEndTimestamp <= 0) {
        daysSpan.innerText = "--";
        hoursSpan.innerText = "--";
        minutesSpan.innerText = "--";
        secondsSpan.innerText = "--";
        return;
      }
      const now = Math.floor(Date.now() / 1000);
      const diff = stageEndTimestamp - now;
      if (diff <= 0) {
        daysSpan.innerText = "00";
        hoursSpan.innerText = "00";
        minutesSpan.innerText = "00";
        secondsSpan.innerText = "00";
        return;
      }
      const d = Math.floor(diff / 86400);
      const h = Math.floor((diff % 86400) / 3600);
      const m = Math.floor((diff % 3600) / 60);
      const s = diff % 60;
      daysSpan.innerText = d < 10 ? "0" + d : String(d);
      hoursSpan.innerText = h < 10 ? "0" + h : String(h);
      minutesSpan.innerText = m < 10 ? "0" + m : String(m);
      secondsSpan.innerText = s < 10 ? "0" + s : String(s);
    }

    function estimateTokens() {
      const val = parseFloat(bnbAmountInput.value);
      if (isNaN(val) || val <= 0) {
        tokenEstimate.innerText = "Enter BNB amount to see estimated $BULL tokens";
        return;
      }
      const estimated = val * currentRate;
      tokenEstimate.innerText = `You will receive approx. ${estimated.toFixed(2)} $BULL`;
    }

    async function refreshContractData() {
      if (!contract) return;
      try {
        const raisedWei = await contract.totalRaised().catch(() => null);
        if (raisedWei) {
          totalRaisedBNB = parseFloat(ethers.utils.formatEther(raisedWei));
          totalRaisedSpan.innerText = totalRaisedBNB.toFixed(2) + " BNB";
        } else {
          totalRaisedSpan.innerText = "0.00 BNB";
        }

        const stage = await contract.currentStage().catch(() => 1);
        currentStageSpan.innerText = stage ? stage.toString() : "1";

        const rate = await contract.getRate().catch(() => null);
        if (rate) {
          currentRate = parseFloat(ethers.utils.formatEther(rate));
          tokenRateSpan.innerText = currentRate.toFixed(0) + " $BULL";
        } else {
          currentRate = 1000 * (stage || 1);
          tokenRateSpan.innerText = currentRate.toFixed(0) + " $BULL";
        }

        const priceWei = await contract.getCurrentPrice().catch(() => null);
        if (priceWei) {
          const priceBNB = parseFloat(ethers.utils.formatEther(priceWei));
          currentPriceSpan.innerText = priceBNB.toFixed(6) + " BNB";
        } else {
          currentPriceSpan.innerText = (1 / currentRate).toFixed(6) + " BNB";
        }

        const endTime = await contract.stageEndTime().catch(() => null);
        stageEndTimestamp = endTime ? endTime.toNumber() : Math.floor(Date.now() / 1000) + 48 * 3600;
        updateCountdown();

        const totalSupplyWei = await contract.totalSupply().catch(() => null);
        if (totalSupplyWei) {
          const totalSupply = ethers.utils.formatEther(totalSupplyWei);
          totalSupplySpan.innerText = Number(totalSupply).toLocaleString() + " $BULL";
        } else {
          totalSupplySpan.innerText = "1,000,000,000 $BULL";
        }

        const capWei = await contract.hardCap().catch(() => null);
        if (capWei) hardcapBNB = parseFloat(ethers.utils.formatEther(capWei));

        let progress = (totalRaisedBNB / hardcapBNB) * 100;
        if (progress > 100) progress = 100;
        progressPercent.innerText = progress.toFixed(1) + "%";
        progressBarFill.style.width = progress + "%";

        if (userAddress && provider) {
          const balWei = await provider.getBalance(userAddress);
          walletBalanceSpan.innerText = parseFloat(ethers.utils.formatEther(balWei)).toFixed(4);
        }

        estimateTokens();
      } catch (e) {
        console.warn("refreshContractData error:", e);
      }
    }

    // ====== ËøûÊé• / Êñ≠ÂºÄÔºàÂºπ‚ÄúÈÄâÊã©Èí±ÂåÖ‚ÄùModalÔºâ======
    function openWalletChooser() {
      // Âè™ÊòæÁ§∫ EVM Èí±ÂåÖÂàóË°®ÔºàÂÉè bullzilla ÈÇ£ÁßçÈÄâÊã©Èí±ÂåÖÂºπÁ™óÔºâ
      // modal.open({ view: "Connect", namespace: "eip155" }) Êù•Ëá™ÂÆòÊñπ Actions ÊñáÊ°£ :contentReference[oaicite:4]{index=4}
      modal.open({ view: "Connect", namespace: "eip155" });
    }

    function disconnectWallet() {
      // ÂÆòÊñπÊé®ËçêÊñ≠ÂºÄÊñπÂºè :contentReference[oaicite:5]{index=5}
      modal.adapter?.connectionControllerClient?.disconnect();
    }

    // ËÆ¢ÈòÖ ProviderÔºöÊãøÂà∞ state["eip155"] ÂêéÁî® ethers v5 ÂåÖË£Ö
    // subscribeProviders Êù•Ëá™ÂÆòÊñπ Actions ÊñáÊ°£ :contentReference[oaicite:6]{index=6}
    modal.subscribeProviders(async (state) => {
      try {
        const nextProvider = state?.["eip155"] || null;

        // Êú™ËøûÊé•
        if (!nextProvider) {
          eip155Provider = null;
          provider = null;
          signer = null;
          contract = null;
          userAddress = null;

          connectBtn.innerText = "Connect Wallet";
          disconnectBtn.style.display = "none";
          buyButton.disabled = true;
          buyButton.innerText = "Connect Wallet To Buy";
          claimButton.style.display = "none";
          walletBalanceSpan.innerText = "0.00";

          showNotification("Disconnected", "Wallet disconnected", false);
          return;
        }

        // Â∑≤ËøûÊé•
        eip155Provider = nextProvider;
        provider = new ethers.providers.Web3Provider(eip155Provider);
        signer = provider.getSigner();

        // ÂÆòÊñπ‰πüÊèê‰æõ modal.getAddress()Ôºà‰ΩÜÂú®‰∏Ä‰∫õÈí±ÂåÖÈáå address ÂèØËÉΩÁ®çÂêéÊâçÂèØÁî®Ôºâ
        userAddress = await signer.getAddress();

        contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        connectBtn.innerText = shortAddr(userAddress);
        disconnectBtn.style.display = "inline-block";
        buyButton.disabled = false;
        buyButton.innerText = "Buy $BULL";
        claimButton.style.display = "block";

        await refreshContractData();
        if (countdownInterval) clearInterval(countdownInterval);
        countdownInterval = setInterval(updateCountdown, 1000);

        showNotification("Connected", "Wallet connected successfully", false);
      } catch (e) {
        console.error(e);
        showNotification("Connect Error", e?.message || String(e), true);
      }
    });

    async function buyTokens() {
      if (!signer || !contract) return;

      const amount = parseFloat(bnbAmountInput.value);
      if (isNaN(amount) || amount <= 0) {
        showNotification("Invalid amount", "Enter a positive BNB amount", true);
        return;
      }

      const slippage = parseFloat(slippageInput.value) / 100;
      const minTokensOut = Math.floor(amount * currentRate * (1 - slippage));
      const referrer = (referrerInput.value || "").trim() || "0x0000000000000000000000000000000000000000";

      try {
        const tx = await contract.buyTokens(referrer, minTokensOut, {
          value: ethers.utils.parseEther(amount.toString())
        });
        showNotification("Purchase Submitted", `Tx: ${tx.hash}`, false);
        await tx.wait();
        showNotification("Success", "You bought $BULL tokens!", false);
        refreshContractData();
      } catch (e) {
        showNotification("Transaction Failed", e?.message || String(e), true);
      }
    }

    async function claimTokens() {
      if (!signer || !contract) return;
      try {
        const tx = await contract.claimTokens();
        showNotification("Claim Submitted", `Tx: ${tx.hash}`, false);
        await tx.wait();
        showNotification("Success", "Tokens claimed!", false);
        refreshContractData();
      } catch (e) {
        showNotification("Claim Failed", e?.message || String(e), true);
      }
    }

    // ====== ÁªëÂÆö‰∫ã‰ª∂ ======
    connectBtn.addEventListener("click", openWalletChooser);
    disconnectBtn.addEventListener("click", disconnectWallet);
    bnbAmountInput.addEventListener("input", estimateTokens);
    buyButton.addEventListener("click", buyTokens);
    claimButton.addEventListener("click", claimTokens);

    // ÂàùÂßãÊòæÁ§∫ÔºàÊú™ËøûÊé•‰πüÁªô‰∏™ÈªòËÆ§Áä∂ÊÄÅÔºâ
    (function initUI() {
      currentPriceSpan.innerHTML = '<span class="loading-spinner"></span>';
      totalRaisedSpan.innerHTML = '<span class="loading-spinner"></span>';
      currentStageSpan.innerHTML = '<span class="loading-spinner"></span>';
      tokenRateSpan.innerHTML = '<span class="loading-spinner"></span>';
      totalSupplySpan.innerHTML = '<span class="loading-spinner"></span>';
      progressPercent.innerText = "0%";
      progressBarFill.style.width = "0%";
      estimateTokens();
    })();
  </script>

</body>
</html>
