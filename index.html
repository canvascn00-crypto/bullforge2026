```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BullForge Presale - Multi-Chain</title>
  <style>
    :root{
      --bg:#050505;
      --bg2:#0d0d0f;
      --card:#0f1115;
      --card2:#12141a;
      --line:rgba(245,215,122,0.25);
      --line2:rgba(255,255,255,0.08);
      --gold:#F5D77A;
      --gold2:#d7b55e;
      --text:#f5f5f5;
      --muted:#a9adb8;
      --danger:#ff6b6b;
      --ok:#6dffb3;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:
      radial-gradient(1200px 700px at 10% -10%,rgba(245,215,122,0.08),transparent),
      radial-gradient(900px 600px at 90% -10%,rgba(245,215,122,0.05),transparent),
      linear-gradient(180deg,#060607,#090a0d 48%,#070709);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .wrap{max-width:1120px;margin:0 auto;padding:18px 16px 44px}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(8px);
      background:rgba(6,6,8,0.72);
      border-bottom:1px solid var(--line2);
    }
    .topbar-in{max-width:1120px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:
        linear-gradient(135deg,rgba(245,215,122,.35),rgba(245,215,122,.08)),
        #111;
      border:1px solid var(--line);
      display:grid;place-items:center;font-size:14px;color:var(--gold);
      box-shadow:0 6px 24px rgba(245,215,122,.12), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav a{
      text-decoration:none;color:#ddd;padding:8px 11px;border-radius:10px;
      border:1px solid transparent;font-size:14px;
    }
    .nav a:hover{border-color:var(--line2);background:rgba(255,255,255,.03)}
    .badge{
      border:1px solid var(--line);
      color:var(--gold);
      padding:8px 12px;border-radius:999px;font-size:12px;font-weight:700;
      background:rgba(245,215,122,0.08);
    }
    .badge.bad{border-color:rgba(255,107,107,.45);color:#ff9b9b;background:rgba(255,107,107,.08)}
    .btn, .btn2{
      border:none;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700
    }
    .btn{
      background:linear-gradient(180deg,#f7de91,#d9b768);
      color:#19150a; box-shadow:0 8px 24px rgba(245,215,122,.24);
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.58;cursor:not-allowed}
    .btn2{
      background:#181b22;color:#e9ecf2;border:1px solid var(--line2);
    }
    .btn2:hover{background:#1d2129}
    .menu-btn{
      display:none;border:1px solid var(--line2);background:#151821;color:#fff;border-radius:10px;padding:8px 10px;font-weight:700
    }

    .mobile-nav{
      display:none;position:absolute;left:16px;right:16px;top:64px;
      background:#111319;border:1px solid var(--line2);border-radius:14px;padding:10px;
      box-shadow:0 12px 32px rgba(0,0,0,.45)
    }
    .mobile-nav a{display:block;padding:10px;border-radius:10px;color:#ddd;text-decoration:none}
    .mobile-nav a:hover{background:rgba(255,255,255,.04)}

    .hero{
      margin-top:16px;
      display:grid;grid-template-columns:1.1fr .9fr;gap:14px;
    }
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line2);
      border-radius:18px;padding:16px;
      box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .headline{
      font-size:40px;line-height:1.04;margin:2px 0 10px;font-weight:900;
      letter-spacing:-.7px;
      background:linear-gradient(180deg,#fff,#d8dbe4);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .sub{color:var(--muted);font-size:15px;line-height:1.6;margin:0 0 14px}
    .hero-cta{display:flex;gap:10px;flex-wrap:wrap}
    .stats{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px
    }
    .stat{
      border:1px solid var(--line2);background:rgba(255,255,255,.02);
      border-radius:12px;padding:10px
    }
    .stat .k{font-size:12px;color:#9fa4b0}
    .stat .v{font-size:18px;font-weight:800;margin-top:2px}

    .section-title{
      margin:18px 0 10px;font-size:13px;font-weight:800;color:#c7ccda;letter-spacing:.6px
    }

    .buy-grid{display:grid;grid-template-columns:1fr .9fr;gap:14px}
    .field{margin:10px 0}
    label{display:block;font-size:12px;color:#b5bbc9;margin-bottom:6px;font-weight:700}
    input{
      width:100%;padding:12px 12px;border-radius:12px;background:#0f1218;color:#f2f4f7;
      border:1px solid #242936;outline:none;
    }
    input:focus{border-color:rgba(245,215,122,.55);box-shadow:0 0 0 3px rgba(245,215,122,.12)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:#97a0b3}

    .chains{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:9px 12px;border-radius:999px;border:1px solid #2a2f3d;background:#121621;
      font-size:12px;font-weight:800;color:#d8dce7;cursor:pointer;
    }
    .chip.active{border-color:var(--line);color:#1a1408;background:linear-gradient(180deg,#f8df93,#d8b766)}
    .chip:hover{filter:brightness(1.04)}

    .big{
      width:100%;padding:13px 14px;border-radius:14px;font-weight:900;letter-spacing:.2px;
      margin-top:8px
    }

    .divider{height:1px;background:var(--line2);margin:12px 0}
    .kv{display:flex;justify-content:space-between;gap:10px;margin:7px 0;font-size:14px}
    .kv .k{color:#a4abbb}
    .kv .v{font-weight:800}
    .muted{color:#9da5b7;font-size:12px}

    .progress{
      height:14px;border-radius:999px;background:#0d1016;border:1px solid #222836;overflow:hidden
    }
    .progress > i{
      display:block;height:100%;width:0%;
      background:linear-gradient(90deg,#ffd56c,#f5d77a,#e7b74d);
      box-shadow:0 0 18px rgba(245,215,122,.35);
      transition:width .4s ease;
    }
    .progress > i.near{
      animation:pulse 1.1s infinite ease-in-out;
      filter:saturate(1.1);
    }
    @keyframes pulse{
      0%,100%{opacity:.92}
      50%{opacity:.62}
    }

    .table{
      width:100%;border:1px solid var(--line2);border-radius:14px;overflow:hidden;margin-top:10px
    }
    .tr{display:grid;grid-template-columns:120px 1fr 160px 160px}
    .th,.td{padding:10px 12px;border-bottom:1px solid #1f2431;font-size:13px}
    .th{font-weight:800;background:#121622;color:#c9ceda}
    .td{color:#e7ebf4}
    .tr:last-child .td{border-bottom:none}
    .empty{padding:18px;color:#95a0b4;text-align:center}

    .notice{
      position:fixed;right:18px;bottom:18px;z-index:100;
      width:min(420px,calc(100vw - 30px));background:#11141c;border:1px solid var(--line);
      border-radius:14px;padding:12px 13px;display:none
    }
    .notice.show{display:block}
    .notice h4{margin:0 0 4px;font-size:14px}
    .notice p{margin:0;color:#b3bac9;font-size:13px;word-break:break-word}

    .foot{
      color:#7f899b;font-size:12px;text-align:center;margin-top:20px;line-height:1.6
    }

    .page{display:none}
    .page.is-active{display:block}

    @media (max-width:980px){
      .hero,.buy-grid{grid-template-columns:1fr}
      .headline{font-size:32px}
      .stats{grid-template-columns:1fr 1fr}
      .nav{display:none}
      .menu-btn{display:inline-block}
      .mobile-nav.show{display:block}
    }
    @media (max-width:560px){
      .stats{grid-template-columns:1fr}
      .tr{grid-template-columns:95px 1fr 120px 120px}
      .th,.td{padding:9px 8px;font-size:12px}
      .topbar-in{padding:10px 12px}
      .wrap{padding:12px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-in">
      <div class="brand">
        <div class="logo">BFG</div>
        <div>BullForge Presale</div>
      </div>

      <nav class="nav">
        <a href="#home" data-nav="home">Home</a>
        <a href="#buy" data-nav="buy">Buy</a>
        <a href="#referrals" data-nav="referrals">Referrals</a>
        <a href="#history" data-nav="history">History</a>
      </nav>

      <div class="row">
        <span id="evmBadge" class="badge" style="display:none">EVM</span>
        <button id="evmConnectBtn" class="btn">Connect EVM</button>
        <button id="evmDisconnectBtn" class="btn2" style="display:none">Disconnect</button>
        <button id="menuBtn" class="menu-btn">Menu</button>
      </div>
    </div>
    <div id="mobileMenu" class="mobile-nav">
      <a href="#home" data-nav="home">Home</a>
      <a href="#buy" data-nav="buy">Buy</a>
      <a href="#referrals" data-nav="referrals">Referrals</a>
      <a href="#history" data-nav="history">History</a>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section class="page is-active" data-page="home">
      <div class="hero">
        <div class="card">
          <div class="badge" id="statusPill">LIVE</div>
          <h1 class="headline">Buy $BFG Across BSC / ETH / SOL / TRON</h1>
          <p class="sub">
            Fast multi-chain checkout experience with live on-chain BSC rate reference.
            Stage increases may reduce token output — secure your allocation early.
          </p>
          <div class="hero-cta">
            <a href="#buy" data-nav="buy"><button class="btn">Buy Now</button></a>
            <a href="#referrals" data-nav="referrals"><button class="btn2">Referral Program</button></a>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">Total Raised</div>
              <div class="v" id="homeRaised">--</div>
            </div>
            <div class="stat">
              <div class="k">Current Stage</div>
              <div class="v" id="homeStage">--</div>
            </div>
            <div class="stat">
              <div class="k">Rate (BFG / BNB)</div>
              <div class="v" id="homeRate">--</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">LIVE PRESALE SNAPSHOT</div>
          <div class="kv"><span class="k">Raised</span><span class="v" id="totalRaised">--</span></div>
          <div class="kv"><span class="k">Raised (USD)</span><span class="v" id="totalRaisedUsd">--</span></div>
          <div class="kv"><span class="k">Current Stage</span><span class="v" id="currentStage">--</span></div>
          <div class="kv"><span class="k">Current Rate</span><span class="v" id="tokenRate">--</span></div>
          <div class="divider"></div>
          <div class="small" id="lastSyncText">LIVE • syncing…</div>
        </div>
      </div>
    </section>

    <!-- BUY -->
    <section class="page" data-page="buy">
      <div class="section-title">BUY TOKENS</div>
      <div class="buy-grid">
        <div class="card">
          <label>Select Payment Chain</label>
          <div id="chainSeg" class="chains">
            <button class="chip active" data-chain="BSC">BSC</button>
            <button class="chip" data-chain="ETH">ETH</button>
            <button class="chip" data-chain="SOL">SOL</button>
            <button class="chip" data-chain="TRON">TRON (USDT)</button>
          </div>

          <div class="field">
            <label id="amountLabel">Enter Amount (BNB)</label>
            <input id="payAmount" type="number" min="0" step="any" placeholder="0.0" />
          </div>

          <div class="field">
            <label>Referrer Address (optional, EVM format)</label>
            <input id="referrerAddress" placeholder="0x..." />
          </div>

          <div class="divider"></div>
          <div class="kv"><span class="k">Approx. Value</span><span id="convUsd" class="v">--</span></div>
          <div class="kv"><span class="k">Estimated You Receive</span><span id="tokensOut" class="v">--</span></div>
          <div class="kv"><span class="k">Token Price (USD)</span><span id="tokenUsd" class="v">--</span></div>
          <div class="muted" id="estNote">Enter an amount to see a live estimate.</div>

          <button id="payButton" class="btn big">Connect EVM To Pay</button>
          <button id="claimButton" class="btn2 big" style="display:none">Claim Your $BFG Tokens (BSC)</button>
        </div>

        <div class="card">
          <div class="section-title">STAGE URGENCY</div>
          <div class="progress"><i id="progFill"></i></div>
          <div class="small" id="progText">--</div>
          <div class="muted" id="stageMsg" style="margin-top:8px">--</div>

          <div class="divider"></div>
          <div class="section-title">CONNECTED WALLETS</div>
          <div class="kv"><span class="k">EVM</span><span class="v" id="myWallet">Not connected</span></div>
          <div class="kv"><span class="k">SOL</span><span class="v" id="mySolWallet">Not connected</span></div>
          <div class="kv"><span class="k">TRON</span><span class="v" id="myTronWallet">Not connected</span></div>

          <div class="divider"></div>
          <div class="section-title">BSC WALLET STATUS</div>
          <div class="kv"><span class="k">Address</span><span class="v" id="evmWalletText">Not connected</span></div>
          <div class="kv"><span class="k">BNB Balance</span><span class="v"><span id="walletBalance">0.00</span> BNB</span></div>
        </div>
      </div>
    </section>

    <!-- REFERRALS -->
    <section class="page" data-page="referrals">
      <div class="section-title">REFERRAL LINKS</div>
      <div class="card">
        <div class="muted">Connect EVM wallet to generate your referral links.</div>
        <div class="field">
          <label>Main Link</label>
          <input id="refLink" readonly value="Connect wallet to generate…" />
        </div>
        <button id="copyRefBtn" class="btn2">Copy Main Link</button>

        <div class="divider"></div>

        <div class="field">
          <label>Backup Link</label>
          <input id="refLink2" readonly value="Connect wallet to generate…" />
        </div>
        <button id="copyRefBtn2" class="btn2">Copy Backup Link</button>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="page" data-page="history">
      <div class="section-title">YOUR LOCAL TRANSACTION HISTORY</div>
      <div class="card">
        <div class="table">
          <div class="tr">
            <div class="th">Chain</div>
            <div class="th">Tx</div>
            <div class="th">Paid</div>
            <div class="th">BFG (Est.)</div>
          </div>
          <div id="histBody" class="empty">You don't have any transactions yet.</div>
        </div>
        <div class="muted" style="margin-top:8px">
          History is stored in your browser localStorage only.
        </div>
      </div>
    </section>

    <div class="foot">
      BullForge interface demo • Always verify official contract and recipient addresses before sending funds.
    </div>
  </main>

  <div id="notification" class="notice">
    <h4 id="notificationTitle">Notice</h4>
    <p id="notificationDesc"></p>
  </div>

  <script type="module">
    import { ethers } from 'https://esm.sh/ethers@5.7.2';
    import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers5@4.1.2';
    import { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } from 'https://esm.sh/@solana/web3.js@1.95.4';

    const CONFIG = {
      TOKEN_SYMBOL: "BFG",
      CONTRACT_ADDRESS: "0x16D6c1a692AaC51a3821bA2903115d4600649F07",
      BSC_RPC: "https://bsc-dataseed.binance.org/",
      BSC_CHAIN_ID: 56,
      BSC_EXPLORER: "https://bscscan.com",
      WALLETCONNECT_PROJECT_ID: "fe819ed06d9e5489f764fc7b1dae1c4e",
      ETH_RECEIVE: "0xA616911194eca5aD6E858a2aCFAC2cDaDC8f04B1",
      SOL_RECEIVE: "AKEpSih1iMbW2m3xqTw2ZZHLByhvbscKVAkuS2R1fs3Y",
      TRON_RECEIVE: "TEDfNwh3D9AwvTbX32BVZP1Gdfph1cWPhd",
      SOL_RPC: "https://api.mainnet-beta.solana.com",
      TRON_USDT_CONTRACT: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"
    };

    const CONTRACT_ABI = [
      "function totalRaised() view returns (uint256)",
      "function currentPriceStage() view returns (uint88)",
      "function currentRate() view returns (uint256)",
      "function lastPriceIncreaseRaised() view returns (uint256)",
      "function presaleActive() view returns (bool)",
      "function presaleEnded() view returns (bool)",
      "function buyTokens(address _referrer, uint256 _minTokensOut) payable",
      "function claimTokens() external"
    ];

    const PRICE_INCREASE_THRESHOLD_BNB = 333;
    const LS_HISTORY_KEY = "bfg_purchase_history_v3";
    const $ = (id) => document.getElementById(id);

    const notif = $("notification"), notifTitle = $("notificationTitle"), notifDesc = $("notificationDesc");
    const menuBtn = $("menuBtn"), mobileMenu = $("mobileMenu");
    const evmBadge = $("evmBadge"), evmConnectBtn = $("evmConnectBtn"), evmDisconnectBtn = $("evmDisconnectBtn");
    const totalRaisedEl = $("totalRaised"), totalRaisedUsdEl = $("totalRaisedUsd"), stageEl = $("currentStage"), tokenRateEl = $("tokenRate");
    const homeRaised = $("homeRaised"), homeStage = $("homeStage"), homeRate = $("homeRate");
    const lastSyncText = $("lastSyncText"), statusPill = $("statusPill");
    const chainSeg = $("chainSeg"), amountLabel = $("amountLabel"), payAmount = $("payAmount");
    const convUsd = $("convUsd"), tokensOut = $("tokensOut"), tokenUsdEl = $("tokenUsd"), estNote = $("estNote");
    const referrerInput = $("referrerAddress"), walletBalanceEl = $("walletBalance"), evmWalletText = $("evmWalletText");
    const payButton = $("payButton"), claimButton = $("claimButton");
    const progFill = $("progFill"), progText = $("progText"), stageMsg = $("stageMsg");
    const myWallet = $("myWallet"), mySolWallet = $("mySolWallet"), myTronWallet = $("myTronWallet");
    const refLink = $("refLink"), refLink2 = $("refLink2"), copyRefBtn = $("copyRefBtn"), copyRefBtn2 = $("copyRefBtn2"), histBody = $("histBody");

    let tronConnectBtn = null;
    function mountTronConnectBtn() {
      if (!chainSeg || tronConnectBtn) return;
      tronConnectBtn = document.createElement("button");
      tronConnectBtn.className = "btn2";
      tronConnectBtn.style.marginTop = "10px";
      tronConnectBtn.style.display = "none";
      tronConnectBtn.textContent = "Connect TRON (TronLink)";
      chainSeg.parentElement?.appendChild(tronConnectBtn);
      tronConnectBtn.addEventListener("click", connectTronWallet);
    }

    function closeMobileMenu(){ mobileMenu?.classList.remove("show"); }
    function setActivePage(pageName){
      const t = pageName || "home";
      document.querySelectorAll(".page").forEach(p => p.classList.toggle("is-active", p.getAttribute("data-page")===t));
      closeMobileMenu(); window.scrollTo({top:0,behavior:"smooth"}); if(t==="buy") refreshAll();
    }
    function getRouteFromHash(){ const raw=(location.hash||"").replace("#","").trim(); return raw||"home"; }
    function bindNav(){
      document.querySelectorAll("[data-nav]").forEach(el=>{
        el.addEventListener("click",(e)=>{ e.preventDefault(); const t=el.getAttribute("data-nav"); history.pushState(null,"",`#${t}`); setActivePage(t); });
      });
      window.addEventListener("hashchange",()=>setActivePage(getRouteFromHash()));
    }

    function showNotification(title, desc="", isError=false){
      notifTitle.innerText=title; notifDesc.innerText=desc;
      notif.style.borderColor = isError ? "var(--danger)" : "rgba(245,215,122,0.55)";
      notif.classList.add("show"); setTimeout(()=>notif.classList.remove("show"),4200);
    }
    const safeShort = (a)=>!a?"—":(a.length<=12?a:`${a.slice(0,6)}...${a.slice(-4)}`);
    const fmtBNB = (x)=>isFinite(x)?`${x.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} BNB`:"--";
    const fmtUSD0 = (x)=>isFinite(x)?`$${x.toLocaleString(undefined,{maximumFractionDigits:0})}`:"--";
    const fmtUSD8 = (x)=>isFinite(x)?`$${x.toFixed(8)}`:"--";
    const parseTokensPerBNB = (r)=>parseFloat(ethers.utils.formatUnits(r,18));
    const isValidAddress = (a)=>{ try{return ethers.utils.isAddress(a);}catch{return false;} };
    const shortHash = (h)=>!h?"—":(h.length>14?`${h.slice(0,8)}…${h.slice(-6)}`:h);

    async function ensureEvmChain(chainIdHex, addParams){
      const wp = await web3Modal?.getWalletProvider?.(); if(!wp?.request) throw new Error("Wallet provider not found");
      try{ await wp.request({method:"wallet_switchEthereumChain",params:[{chainId:chainIdHex}]});}
      catch(e){ if(e?.code===4902 && addParams) await wp.request({method:"wallet_addEthereumChain",params:[addParams]}); else throw e; }
    }

    function loadHistory(){ try{ const raw=localStorage.getItem(LS_HISTORY_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[];}catch{return[];} }
    function saveHistory(arr){ localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(arr.slice(0,250))); }
    function addHistoryItem(item){ const arr=loadHistory(); arr.unshift(item); saveHistory(arr); renderHistory(); }
    function updateHistoryStatus(tx,status){ const arr=loadHistory(); const i=arr.findIndex(x=>x.tx===tx); if(i>=0){arr[i].status=status; saveHistory(arr); renderHistory();} }
    function renderHistory(){
      const arr=loadHistory();
      if(!arr.length){ histBody.className="empty"; histBody.innerText="You don't have any transactions yet."; return; }
      histBody.className="";
      histBody.innerHTML = arr.map(x=>{
        const explorer=x.explorer||"";
        const txCell = explorer
          ? `<a class="td" href="${explorer}" target="_blank" rel="noreferrer" style="color:rgba(245,215,122,0.92);text-decoration:none" title="${x.tx}">${shortHash(x.tx)}</a>`
          : `<div class="td" title="${x.tx}">${shortHash(x.tx)}</div>`;
        const status=(x.status||"confirmed").toLowerCase();
        const icon=status==="confirmed"?"✅":status==="failed"?"❌":"⏳";
        return `<div class="tr"><div class="td"><b>${x.chain}</b></div>${txCell}<div class="td">${x.paid} ${icon}</div><div class="td"><b>${x.bfg}</b></div></div>`;
      }).join("");
    }

    let totalRaisedBNB=0,lastRaisedBNB=0,stage=0,tokensPerBNB=0,presaleActive=false,presaleEnded=false;
    let pricesUSD={bnb:null,eth:null,sol:null},lastPricesFetch=0;

    async function fetchPricesUSD(){
      if(Date.now()-lastPricesFetch<60000 && pricesUSD.bnb) return pricesUSD;
      const res=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=binancecoin,ethereum,solana&vs_currencies=usd",{cache:"no-store"});
      if(!res.ok) throw new Error("Price feed failed");
      const d=await res.json();
      pricesUSD={bnb:Number(d?.binancecoin?.usd||0)||null,eth:Number(d?.ethereum?.usd||0)||null,sol:Number(d?.solana?.usd||0)||null};
      lastPricesFetch=Date.now(); return pricesUSD;
    }
    const tokenUsdPrice = ()=> (pricesUSD.bnb && tokensPerBNB) ? (pricesUSD.bnb/tokensPerBNB) : null;

    async function refreshContractData(){
      const p=new ethers.providers.JsonRpcProvider(CONFIG.BSC_RPC);
      const c=new ethers.Contract(CONFIG.CONTRACT_ADDRESS,CONTRACT_ABI,p);
      const [raisedWei,stageRaw,rateRaw,lastRaisedWei,active,ended] = await Promise.all([
        c.totalRaised(), c.currentPriceStage().catch(()=>0), c.currentRate(), c.lastPriceIncreaseRaised().catch(()=>0),
        c.presaleActive().catch(()=>false), c.presaleEnded().catch(()=>false)
      ]);
      totalRaisedBNB=parseFloat(ethers.utils.formatEther(raisedWei));
      stage=Number(stageRaw.toString());
      tokensPerBNB=parseTokensPerBNB(rateRaw);
      lastRaisedBNB=parseFloat(ethers.utils.formatEther(lastRaisedWei));
      presaleActive=!!active; presaleEnded=!!ended;
    }

    function renderTopStats(){
      totalRaisedEl.innerText=fmtBNB(totalRaisedBNB);
      const usd=(pricesUSD.bnb&&isFinite(totalRaisedBNB))?totalRaisedBNB*pricesUSD.bnb:NaN;
      totalRaisedUsdEl.innerText=isFinite(usd)?fmtUSD0(usd):"--";
      stageEl.innerText=String(stage);
      tokenRateEl.innerText=tokensPerBNB?`${Math.floor(tokensPerBNB).toLocaleString()} BFG`:"--";
      homeRaised.innerText=fmtBNB(totalRaisedBNB); homeStage.innerText=String(stage);
      homeRate.innerText=tokensPerBNB?`${Math.floor(tokensPerBNB).toLocaleString()} BFG`:"--";
      statusPill.innerText = presaleEnded ? "PRESALE ENDED" : (presaleActive ? `LIVE • STAGE ${stage}` : "NOT STARTED");
    }

    function renderUrgency(){
      const delta=Math.max(totalRaisedBNB-lastRaisedBNB,0);
      const p=Math.max(Math.min(delta/PRICE_INCREASE_THRESHOLD_BNB,1),0);
      const remain=Math.max(PRICE_INCREASE_THRESHOLD_BNB-delta,0);
      progFill.style.width=(p*100).toFixed(1)+"%";
      progFill.classList.toggle("near",p>=0.85);
      progText.innerText=`${(p*100).toFixed(1)}% • ${remain.toFixed(2)} BNB to next stage trigger.`;
      const next=tokensPerBNB?Math.floor(tokensPerBNB*0.9):null;
      stageMsg.innerText = presaleEnded ? "Presale ended on-chain." :
        (!presaleActive ? "Waiting for presale activation on-chain." :
        (next ? `Stage ${stage} is live. Next stage may reduce tokens per BNB by ~10% (estimate: ~${next.toLocaleString()} BFG/BNB).` : `Stage ${stage} is live.`));
    }

    let selectedChain="BSC";
    function setSelectedChain(chain){
      selectedChain=chain;
      [...chainSeg.querySelectorAll(".chip")].forEach(el=>el.classList.toggle("active",el.dataset.chain===chain));
      if(chain==="BSC") amountLabel.innerText="Enter Amount (BNB)";
      if(chain==="ETH") amountLabel.innerText="Enter Amount (ETH)";
      if(chain==="SOL") amountLabel.innerText="Enter Amount (SOL)";
      if(chain==="TRON") amountLabel.innerText="Enter Amount (USDT - TRC20)";
      if(tronConnectBtn) tronConnectBtn.style.display = chain==="TRON" ? "block":"none";
      updatePayButtonState(); updateEstimates();
    }

    async function updateEstimates(){
      const amt=parseFloat(payAmount.value||"0");
      if(!amt||amt<=0){convUsd.innerText="--";tokensOut.innerText="--";estNote.innerText="Enter an amount to see a live estimate.";return;}
      try{await fetchPricesUSD();}catch{estNote.innerText="Price feed unavailable (rate estimate only).";return;}
      const tUsd=tokenUsdPrice(); if(!tUsd){estNote.innerText="Loading on-chain pricing reference…";return;}
      let payUsd=null;
      if(selectedChain==="BSC") payUsd=pricesUSD.bnb?amt*pricesUSD.bnb:null;
      if(selectedChain==="ETH") payUsd=pricesUSD.eth?amt*pricesUSD.eth:null;
      if(selectedChain==="SOL") payUsd=pricesUSD.sol?amt*pricesUSD.sol:null;
      if(selectedChain==="TRON") payUsd=amt;
      if(!payUsd){estNote.innerText="Loading market price for selected chain…";return;}
      const out=payUsd/tUsd;
      convUsd.innerText=fmtUSD0(payUsd);
      tokensOut.innerText=out.toLocaleString(undefined,{maximumFractionDigits:2})+" BFG";
      tokenUsdEl.innerText=fmtUSD8(tUsd);
      const next=tokensPerBNB?Math.floor(tokensPerBNB*0.9):null;
      estNote.innerText=`Pricing reference: BSC on-chain rate. Current: 1 BNB ≈ ${Math.floor(tokensPerBNB).toLocaleString()} BFG. ${next?`Next stage estimate: ~${next.toLocaleString()} BFG/BNB.`:""}`;
    }

    let web3Modal=null,evmProvider=null,evmSigner=null,evmAddress=null,presaleContract=null;

    async function connectTronWallet(){
      try{
        if(!window.tronWeb){showNotification("Wallet Required","请先安装 TronLink 扩展或使用支持 TronLink 的内置浏览器。",true);return;}
        if(window.tronLink?.request) await window.tronLink.request({method:"tron_requestAccounts"});
        if(!window.tronWeb.ready || !window.tronWeb.defaultAddress?.base58){showNotification("TRON 未连接","请打开 TronLink 并授权当前站点。",true);return;}
        const a=window.tronWeb.defaultAddress.base58; myTronWallet.innerText=safeShort(a);
        showNotification("TRON Connected",`Tron wallet ${safeShort(a)} connected.`); updatePayButtonState();
      }catch(e){showNotification("TRON Connect Failed",e?.message||String(e),true);}
    }

    function initWeb3Modal(){
      const chains=[
        { chainId:1,name:"Ethereum",currency:"ETH",explorerUrl:"https://etherscan.io",rpcUrl:"https://rpc.ankr.com/eth" },
        { chainId:CONFIG.BSC_CHAIN_ID,name:"BNB Smart Chain",currency:"BNB",explorerUrl:CONFIG.BSC_EXPLORER,rpcUrl:CONFIG.BSC_RPC }
      ];
      const ethersConfig=defaultConfig({
        metadata:{name:"BullForge",description:"BullForge Multi-chain Buy",url:window.location.origin,icons:["https://walletconnect.com/walletconnect-logo.png"]},
        defaultChainId:CONFIG.BSC_CHAIN_ID,rpcUrl:CONFIG.BSC_RPC,projectId:CONFIG.WALLETCONNECT_PROJECT_ID
      });
      web3Modal=createWeb3Modal({ethersConfig,chains,projectId:CONFIG.WALLETCONNECT_PROJECT_ID,themeMode:"dark",themeVariables:{"--w3m-accent":"#F5D77A"}});
    }

    async function connectEVM(){
      try{
        evmConnectBtn.disabled=true; evmConnectBtn.innerText="Connecting…";
        await web3Modal.open();
        const wp=await web3Modal.getWalletProvider?.(); if(!wp) throw new Error("Wallet provider not found");
        evmProvider=new ethers.providers.Web3Provider(wp); evmSigner=evmProvider.getSigner(); evmAddress=await evmSigner.getAddress();
        presaleContract=new ethers.Contract(CONFIG.CONTRACT_ADDRESS,CONTRACT_ABI,evmSigner);
        evmConnectBtn.innerText=safeShort(evmAddress); evmDisconnectBtn.style.display="inline-block"; evmBadge.style.display="inline-block";
        const net=await evmProvider.getNetwork(); evmBadge.classList.toggle("bad",![1,CONFIG.BSC_CHAIN_ID].includes(net.chainId)); evmBadge.innerText=`EVM • ${net.chainId}`;
        myWallet.innerText=safeShort(evmAddress); evmWalletText.innerText=safeShort(evmAddress);
        const rl=`${window.location.origin}${window.location.pathname}?ref=${evmAddress}`; refLink.value=rl; refLink2.value=rl;
        await updateBalances(); updatePayButtonState(); showNotification("Connected",`EVM wallet ${safeShort(evmAddress)} connected.`);
      }catch(e){showNotification("Connection Failed",e?.message||String(e),true);}
      finally{evmConnectBtn.disabled=false; if(!evmAddress) evmConnectBtn.innerText="Connect EVM";}
    }

    async function disconnectEVM(){
      try{ if(web3Modal?.disconnect) await web3Modal.disconnect(); }catch{}
      evmProvider=null;evmSigner=null;evmAddress=null;presaleContract=null;
      evmConnectBtn.innerText="Connect EVM";evmDisconnectBtn.style.display="none";evmBadge.style.display="none";
      myWallet.innerText="Not connected";evmWalletText.innerText="Not connected";walletBalanceEl.innerText="0.00";
      refLink.value="Connect wallet to generate…"; refLink2.value="Connect wallet to generate…";
      updatePayButtonState(); showNotification("Disconnected","EVM wallet disconnected.");
    }

    async function updateBalances(){
      try{
        if(!evmProvider||!evmAddress) return;
        const net=await evmProvider.getNetwork();
        if(net.chainId===CONFIG.BSC_CHAIN_ID){
          const bal=await evmProvider.getBalance(evmAddress);
          walletBalanceEl.innerText=parseFloat(ethers.utils.formatEther(bal)).toFixed(4);
        } else walletBalanceEl.innerText="—";
      }catch{}
    }

    function updatePayButtonState(){
      if(selectedChain==="BSC"||selectedChain==="ETH"){ const ok=!!evmSigner; payButton.disabled=!ok; payButton.innerText=ok?`Pay with ${selectedChain}`:"Connect EVM To Pay"; return; }
      if(selectedChain==="SOL"){ const ok=!!window.solana; payButton.disabled=!ok; payButton.innerText=ok?"Connect Wallet & Pay (SOL)":"Install Phantom/Solflare"; return; }
      if(selectedChain==="TRON"){
        const has=!!window.tronWeb, con=!!(window.tronWeb?.ready&&window.tronWeb?.defaultAddress?.base58);
        payButton.disabled=!has; payButton.innerText=!has?"Install TronLink":(!con?"Connect TronLink First":"Pay with USDT (TRC20)");
      }
    }

    async function payBSC(){ /* same as above logic */ try{
      if(!presaleContract||!evmProvider) return showNotification("Not Connected","Connect your EVM wallet first.",true);
      const amt=parseFloat(payAmount.value||"0"); if(!amt||amt<=0) return showNotification("Invalid Amount","Enter a valid BNB amount.",true);
      let ref=(referrerInput.value||"").trim(); if(!ref) ref=ethers.constants.AddressZero;
      if(ref!==ethers.constants.AddressZero && !isValidAddress(ref)) return showNotification("Invalid Referrer","Referrer address is invalid.",true);
      if(evmAddress && ref.toLowerCase()===evmAddress.toLowerCase()) ref=ethers.constants.AddressZero;
      payButton.disabled=true; payButton.innerText="Switching Network…";
      await ensureEvmChain("0x38",{chainId:"0x38",chainName:"BNB Smart Chain",nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},rpcUrls:[CONFIG.BSC_RPC],blockExplorerUrls:[CONFIG.BSC_EXPLORER]});
      payButton.innerText="Processing…";
      const tx=await presaleContract.buyTokens(ref,ethers.constants.Zero,{value:ethers.utils.parseEther(String(amt))});
      showNotification("Transaction Sent",tx.hash);
      const tUsd=tokenUsdPrice(), est=(tUsd&&pricesUSD.bnb)?((amt*pricesUSD.bnb)/tUsd):(amt*tokensPerBNB);
      addHistoryItem({ts:Date.now(),chain:"BSC",tx:tx.hash,explorer:`${CONFIG.BSC_EXPLORER}/tx/${tx.hash}`,paid:`${amt} BNB`,bfg:est?est.toLocaleString(undefined,{maximumFractionDigits:2}):"--",status:"pending"});
      await tx.wait(); updateHistoryStatus(tx.hash,"confirmed"); showNotification("Payment Confirmed","BSC purchase confirmed on-chain."); await refreshAll(); await updateBalances();
    }catch(e){showNotification("Payment Failed",e?.data?.message||e?.message||String(e),true);} finally{payButton.disabled=false;updatePayButtonState();}}

    async function payETH(){ try{
      if(!evmSigner||!evmProvider) return showNotification("Not Connected","Connect your EVM wallet first.",true);
      const amt=parseFloat(payAmount.value||"0"); if(!amt||amt<=0) return showNotification("Invalid Amount","Enter a valid ETH amount.",true);
      payButton.disabled=true; payButton.innerText="Switching Network…"; await ensureEvmChain("0x1"); payButton.innerText="Processing…";
      const tx=await evmSigner.sendTransaction({to:CONFIG.ETH_RECEIVE,value:ethers.utils.parseEther(String(amt))});
      showNotification("Transaction Sent",tx.hash);
      const tUsd=tokenUsdPrice(), pu=pricesUSD.eth?(amt*pricesUSD.eth):null, est=(tUsd&&pu)?(pu/tUsd):null;
      addHistoryItem({ts:Date.now(),chain:"ETH",tx:tx.hash,explorer:`https://etherscan.io/tx/${tx.hash}`,paid:`${amt} ETH`,bfg:est?est.toLocaleString(undefined,{maximumFractionDigits:2}):"--",status:"pending"});
      await tx.wait(); updateHistoryStatus(tx.hash,"confirmed"); showNotification("Payment Confirmed","ETH payment confirmed.");
    }catch(e){showNotification("Payment Failed",e?.data?.message||e?.message||String(e),true);} finally{payButton.disabled=false;updatePayButtonState();}}

    async function paySOL(){ try{
      const amt=parseFloat(payAmount.value||"0"); if(!amt||amt<=0) return showNotification("Invalid Amount","Enter a valid SOL amount.",true);
      if(!window.solana) return showNotification("Wallet Required","Please install a Solana wallet.",true);
      payButton.disabled=true; payButton.innerText="Opening Wallet…";
      const solana=window.solana, conn=new Connection(CONFIG.SOL_RPC,"confirmed"); if(!solana.isConnected) await solana.connect();
      const from=solana.publicKey; mySolWallet.innerText=safeShort(from?.toString()||"");
      const tx=new Transaction().add(SystemProgram.transfer({fromPubkey:from,toPubkey:new PublicKey(CONFIG.SOL_RECEIVE),lamports:Math.round(amt*LAMPORTS_PER_SOL)}));
      tx.feePayer=from; tx.recentBlockhash=(await conn.getLatestBlockhash("finalized")).blockhash; payButton.innerText="Confirm in Wallet…";
      let sig; if(solana.signAndSendTransaction){ const r=await solana.signAndSendTransaction(tx); sig=r?.signature||r; } else { const s=await solana.signTransaction(tx); sig=await conn.sendRawTransaction(s.serialize());}
      showNotification("Transaction Sent",String(sig));
      const tUsd=tokenUsdPrice(), pu=pricesUSD.sol?(amt*pricesUSD.sol):null, est=(tUsd&&pu)?(pu/tUsd):null;
      addHistoryItem({ts:Date.now(),chain:"SOL",tx:String(sig),explorer:`https://solscan.io/tx/${sig}`,paid:`${amt} SOL`,bfg:est?est.toLocaleString(undefined,{maximumFractionDigits:2}):"--",status:"pending"});
      await conn.confirmTransaction(String(sig),"confirmed"); updateHistoryStatus(String(sig),"confirmed"); showNotification("Payment Confirmed","SOL payment confirmed.");
    }catch(e){showNotification("Payment Failed",e?.message||String(e),true);} finally{payButton.disabled=false;updatePayButtonState();}}

    async function payTRON_USDT(){ try{
      const amt=parseFloat(payAmount.value||"0"); if(!amt||amt<=0) return showNotification("Invalid Amount","Enter a valid USDT amount.",true);
      await connectTronWallet(); if(!window.tronWeb?.ready) return;
      payButton.disabled=true; payButton.innerText="Checking Wallet…";
      const tw=window.tronWeb, from=tw.defaultAddress?.base58; myTronWallet.innerText=safeShort(from||"");
      if(!from) return showNotification("Not Connected","Open TronLink and connect this site.",true);
      const usdt=await tw.contract().at(CONFIG.TRON_USDT_CONTRACT);
      payButton.innerText="Confirm in Wallet…";
      const txid=await usdt.transfer(CONFIG.TRON_RECEIVE,Math.round(amt*1_000_000)).send({feeLimit:30000000});
      showNotification("Transaction Sent",String(txid));
      const tUsd=tokenUsdPrice(), est=(tUsd&&amt)?(amt/tUsd):null;
      addHistoryItem({ts:Date.now(),chain:"TRON (USDT)",tx:String(txid),explorer:`https://tronscan.org/#/transaction/${txid}`,paid:`${amt} USDT (TRC20)`,bfg:est?est.toLocaleString(undefined,{maximumFractionDigits:2}):"--",status:"pending"});
    }catch(e){showNotification("Payment Failed",e?.message||String(e),true);} finally{payButton.disabled=false;updatePayButtonState();}}

    async function claimBSC(){
      try{
        if(!presaleContract||!evmProvider) return showNotification("Not Connected","Connect your EVM wallet first.",true);
        claimButton.disabled=true; claimButton.innerText="Switching Network…";
        await ensureEvmChain("0x38",{chainId:"0x38",chainName:"BNB Smart Chain",nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},rpcUrls:[CONFIG.BSC_RPC],blockExplorerUrls:[CONFIG.BSC_EXPLORER]});
        claimButton.innerText="Claiming…"; const tx=await presaleContract.claimTokens(); showNotification("Claim Sent",tx.hash); await tx.wait(); showNotification("Claim Success","Tokens claimed.");
      }catch(e){showNotification("Claim Failed",e?.data?.message||e?.message||String(e),true);}
      finally{claimButton.disabled=false;claimButton.innerText="Claim Your $BFG Tokens (BSC)";}
    }

    async function onPay(){ if(selectedChain==="BSC") return payBSC(); if(selectedChain==="ETH") return payETH(); if(selectedChain==="SOL") return paySOL(); if(selectedChain==="TRON") return payTRON_USDT(); }
    async function copyText(txt){ try{await navigator.clipboard.writeText(txt);showNotification("Copied","Copied to clipboard.");}catch{showNotification("Copy Failed","Please copy manually.",true);} }

    async function refreshAll(){
      const t0=Date.now();
      try{
        await Promise.all([refreshContractData(),fetchPricesUSD()]); renderTopStats(); renderUrgency(); updateEstimates();
        lastSyncText.innerText=`LIVE • synced (${Date.now()-t0}ms)`;
      }catch{ lastSyncText.innerText="Sync failed"; }
      claimButton.style.display = presaleEnded ? "block" : "none";
      updatePayButtonState();
    }

    bindNav();
    menuBtn.addEventListener("click",()=>mobileMenu.classList.toggle("show"));
    document.addEventListener("click",(e)=>{ if(!mobileMenu.classList.contains("show"))return; const inside=mobileMenu.contains(e.target)||menuBtn.contains(e.target); if(!inside) mobileMenu.classList.remove("show"); });
    chainSeg.addEventListener("click",(e)=>{ const t=e.target?.closest?.(".chip"); if(!t)return; setSelectedChain(t.dataset.chain); });
    payAmount.addEventListener("input",updateEstimates);
    evmConnectBtn.addEventListener("click",connectEVM); evmDisconnectBtn.addEventListener("click",disconnectEVM);
    payButton.addEventListener("click",onPay); claimButton.addEventListener("click",claimBSC);
    copyRefBtn.addEventListener("click",()=>copyText(refLink.value||"")); copyRefBtn2.addEventListener("click",()=>copyText(refLink2.value||""));

    initWeb3Modal(); mountTronConnectBtn(); renderHistory(); setSelectedChain("BSC"); setActivePage(getRouteFromHash());
    refreshAll(); setInterval(refreshAll,15000);
    setInterval(()=>{ updatePayButtonState(); if(window.solana?.publicKey) mySolWallet.innerText=safeShort(window.solana.publicKey.toString()); if(window.tronWeb?.ready&&window.tronWeb.defaultAddress?.base58) myTronWallet.innerText=safeShort(window.tronWeb.defaultAddress.base58); },2000);
  </script>
</body>
</html>
```
