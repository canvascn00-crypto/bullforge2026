<script type="module">
  import { createAppKit } from "https://esm.sh/@reown/appkit@1.8.15";
  import { Ethers5Adapter } from "https://esm.sh/@reown/appkit-adapter-ethers5@1.6.0";
  import { bsc } from "https://esm.sh/@reown/appkit/networks@1.8.15";

  // 你上面已经用 UMD 引了 ethers
  const { ethers } = window;

  // ==================== 核心配置 ====================
  const CONFIG = {
    CONTRACT_ADDRESS: "0x16D6c1a692AaC51a3821bA2903115d4600649F07",
    WALLETCONNECT_PROJECT_ID: "fe819ed06d9e5489f764fc7b1dae1c4e",
    BSC_RPC: "https://bsc-dataseed.binance.org/",
    CHAIN_ID: 56,
    CHAIN_NAME: "BNB Smart Chain",
    CURRENCY: "BNB",
    EXPLORER: "https://bscscan.com"
  };

  // 完整ABI (包含预售方法和 Buy 事件)
  const CONTRACT_ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint amount) returns (bool)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function transferFrom(address from, address to, uint256 amount) returns (bool)",
    "function totalRaised() view returns (uint256)",
    "function currentStage() view returns (uint256)",
    "function stageEndTime() view returns (uint256)",
    "function getCurrentPrice() view returns (uint256)",
    "function getRate() view returns (uint256)",
    "function hardCap() view returns (uint256)",
    "function contributed(address) view returns (uint256)",
    "function referralRewards(address) view returns (uint256)",
    "function buyTokens(address _referrer, uint256 _minTokensOut) payable",
    "function claimTokens() external",
    "event Buy(address indexed buyer, uint256 bnbAmount, uint256 tokenAmount, uint256 price, address indexed referrer)"
  ];

  // ==================== AppKit 初始化（弹窗钱包选择） ====================
  const projectId = CONFIG.WALLETCONNECT_PROJECT_ID;

  const metadata = {
    name: "Bullforge",
    description: "Bullforge Presale",
    // ⚠️ 必须是 origin，不要带 /BullForge/
    url: "https://canvascn00-crypto.github.io",
    icons: ["https://avatars.githubusercontent.com/u/179229932"]
  };

  const modal = createAppKit({
    projectId,
    metadata,
    networks: [bsc],
    adapters: [new Ethers5Adapter()]
  });

  // ==================== UI 元素 ====================
  const notif = document.getElementById("notification");
  const notifTitle = document.getElementById("notificationTitle");
  const notifDesc = document.getElementById("notificationDesc");
  const connectBtn = document.getElementById("walletConnectBtn");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const buyButton = document.getElementById("buyButton");
  const claimButton = document.getElementById("claimButton");
  const bnbAmountInput = document.getElementById("bnbAmount");
  const slippageInput = document.getElementById("slippage");
  const referrerInput = document.getElementById("referrerAddress");
  const tokenEstimate = document.getElementById("tokenEstimate");
  const walletBalanceSpan = document.getElementById("walletBalance");
  const currentPriceSpan = document.getElementById("currentPrice");
  const totalRaisedSpan = document.getElementById("totalRaised");
  const currentStageSpan = document.getElementById("currentStage");
  const tokenRateSpan = document.getElementById("tokenRate");
  const totalSupplySpan = document.getElementById("totalSupplyDisplay");
  const progressPercent = document.getElementById("progressPercent");
  const progressBarFill = document.getElementById("progressBarFill");
  const dashboardGrid = document.getElementById("dashboardGrid");
  const dashboardNotice = document.getElementById("dashboardNotice");
  const referralBox = document.getElementById("referralBox");
  const referralLink = document.getElementById("referralLink");
  const copyBtn = document.getElementById("copyReferralBtn");
  const userPurchasedSpan = document.getElementById("userPurchased");
  const userReferralRewardsSpan = document.getElementById("userReferralRewards");
  const userStakedSpan = document.getElementById("userStaked");
  const userClaimStatusSpan = document.getElementById("userClaimStatus");
  const stakingCard = document.getElementById("stakingCard");
  const portfolioCard = document.getElementById("portfolioCard");
  const portfolioValue = document.getElementById("portfolioValue");
  const tokenBalanceDetail = document.getElementById("tokenBalanceDetail");
  const historyTable = document.getElementById("historyTable");
  const historyBody = document.getElementById("historyBody");

  // 倒计时元素
  const daysSpan = document.getElementById("countdownDays");
  const hoursSpan = document.getElementById("countdownHours");
  const minutesSpan = document.getElementById("countdownMinutes");
  const secondsSpan = document.getElementById("countdownSeconds");

  // ==================== 全局变量 ====================
  let provider = null;       // 连接后：Web3Provider
  let signer = null;         // 连接后：Signer
  let contract = null;       // 连接后：合约(signer)
  let userAddress = null;

  // 未连接也要能读链：只读 provider + 合约(read)
  const readProvider = new ethers.providers.JsonRpcProvider(CONFIG.BSC_RPC);
  const readContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

  let currentRate = 0;
  let totalRaisedBNB = 0;
  let hardcapBNB = 2000;
  let stageEndTimestamp = 0;
  let countdownInterval;

  function showNotification(title, desc, isError = false) {
    notifTitle.innerText = title;
    notifDesc.innerText = desc;
    notif.classList.add("show");
    notif.style.borderColor = isError ? "var(--danger)" : "var(--gold-primary)";
    setTimeout(() => notif.classList.remove("show"), 5000);
  }

  function updateCountdown() {
    if (!stageEndTimestamp || stageEndTimestamp <= 0) {
      daysSpan.innerText = "--"; hoursSpan.innerText = "--"; minutesSpan.innerText = "--"; secondsSpan.innerText = "--";
      return;
    }
    const now = Math.floor(Date.now() / 1000);
    const diff = stageEndTimestamp - now;
    if (diff <= 0) {
      daysSpan.innerText = "00"; hoursSpan.innerText = "00"; minutesSpan.innerText = "00"; secondsSpan.innerText = "00";
      return;
    }
    const d = Math.floor(diff / 86400);
    const h = Math.floor((diff % 86400) / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;
    daysSpan.innerText = d < 10 ? "0" + d : d;
    hoursSpan.innerText = h < 10 ? "0" + h : h;
    minutesSpan.innerText = m < 10 ? "0" + m : m;
    secondsSpan.innerText = s < 10 ? "0" + s : s;
  }

  function getActiveContractForReads() {
    // 优先使用连接后的 signer 合约，否则用只读合约
    return contract || readContract;
  }

  async function loadUserHistory() {
    const activeContract = getActiveContractForReads();
    if (!activeContract || !userAddress) return;

    try {
      const filter = activeContract.filters.Buy(userAddress);
      const events = await activeContract.queryFilter(filter, -10000);
      events.sort((a, b) => b.blockNumber - a.blockNumber);
      const history = events.slice(0, 5);

      if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">暂无购买记录</td></tr>';
      } else {
        historyBody.innerHTML = "";
        for (let ev of history) {
          const block = await ev.getBlock();
          const date = new Date(block.timestamp * 1000).toLocaleString();
          const bnbAmount = ethers.utils.formatEther(ev.args.bnbAmount);
          const tokenAmount = ethers.utils.formatEther(ev.args.tokenAmount);
          const price = ethers.utils.formatEther(ev.args.price);
          historyBody.innerHTML += `<tr><td>${date}</td><td>${bnbAmount}</td><td>${Number(tokenAmount).toFixed(2)}</td><td>${price}</td></tr>`;
        }
      }
      historyTable.style.display = "table";
    } catch (e) {
      console.warn("获取历史失败", e);
      historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">无法获取历史记录（可能合约无事件）</td></tr>';
      historyTable.style.display = "table";
    }
  }

  async function refreshContractData() {
    const activeContract = getActiveContractForReads();
    if (!activeContract) return;

    try {
      let raisedWei = await activeContract.totalRaised().catch(() => null);
      if (raisedWei) {
        totalRaisedBNB = parseFloat(ethers.utils.formatEther(raisedWei));
        totalRaisedSpan.innerText = totalRaisedBNB.toFixed(2) + " BNB";
      } else {
        totalRaisedSpan.innerText = "0.00 BNB";
      }

      let stage = await activeContract.currentStage().catch(() => 1);
      currentStageSpan.innerText = stage ? stage.toString() : "1";

      let rate = await activeContract.getRate().catch(() => null);
      if (rate) {
        currentRate = parseFloat(ethers.utils.formatEther(rate));
        tokenRateSpan.innerText = currentRate.toFixed(0) + " $BULL";
      } else {
        currentRate = 1000 * (stage || 1);
        tokenRateSpan.innerText = currentRate.toFixed(0) + " $BULL";
      }

      let priceWei = await activeContract.getCurrentPrice().catch(() => null);
      if (priceWei) {
        let priceBNB = parseFloat(ethers.utils.formatEther(priceWei));
        currentPriceSpan.innerText = priceBNB.toFixed(6) + " BNB";
      } else {
        currentPriceSpan.innerText = (1 / currentRate).toFixed(6) + " BNB";
      }

      let endTime = await activeContract.stageEndTime().catch(() => null);
      if (endTime) stageEndTimestamp = endTime.toNumber();
      else stageEndTimestamp = Math.floor(Date.now() / 1000) + 48 * 3600;
      updateCountdown();

      let totalSupplyWei = await activeContract.totalSupply().catch(() => null);
      if (totalSupplyWei) {
        let totalSupply = ethers.utils.formatEther(totalSupplyWei);
        totalSupplySpan.innerText = Number(totalSupply).toLocaleString() + " $BULL";
      } else {
        totalSupplySpan.innerText = "1,000,000,000 $BULL";
      }

      let capWei = await activeContract.hardCap().catch(() => null);
      if (capWei) hardcapBNB = parseFloat(ethers.utils.formatEther(capWei));

      let progress = (totalRaisedBNB / hardcapBNB) * 100;
      if (progress > 100) progress = 100;
      progressPercent.innerText = progress.toFixed(1) + "%";
      progressBarFill.style.width = progress + "%";

      // ===== 用户相关（仅连接后） =====
      if (userAddress && provider) {
        let purchasedWei = await activeContract.contributed(userAddress).catch(() => null);
        if (purchasedWei) {
          let purchased = parseFloat(ethers.utils.formatEther(purchasedWei));
          userPurchasedSpan.innerText = purchased.toFixed(4) + " BNB";
        } else {
          userPurchasedSpan.innerText = "0 BNB";
        }

        let rewardsWei = await activeContract.referralRewards(userAddress).catch(() => null);
        if (rewardsWei) {
          let rewards = ethers.utils.formatEther(rewardsWei);
          userReferralRewardsSpan.innerText = Number(rewards).toFixed(2) + " $BULL";
        } else {
          userReferralRewardsSpan.innerText = "0 $BULL";
        }

        let balWei = await provider.getBalance(userAddress);
        walletBalanceSpan.innerText = parseFloat(ethers.utils.formatEther(balWei)).toFixed(4);

        let tokenBalanceWei = await activeContract.balanceOf(userAddress).catch(() => ethers.BigNumber.from(0));
        let tokenBalance = parseFloat(ethers.utils.formatEther(tokenBalanceWei));
        tokenBalanceDetail.innerText = `持有 $BULL: ${tokenBalance.toFixed(2)}`;

        let pricePerToken = 1 / currentRate;
        let portfolioValueBNB = tokenBalance * pricePerToken;
        portfolioValue.innerText = `${portfolioValueBNB.toFixed(4)} BNB`;
        portfolioCard.style.display = "block";

        loadUserHistory();
      }

      estimateTokens();
    } catch (e) {
      console.warn("合约读取失败，使用模拟数据", e);
      totalRaisedSpan.innerText = "125.45 BNB";
      currentStageSpan.innerText = "2";
      currentRate = 2500;
      tokenRateSpan.innerText = currentRate + " $BULL";
      currentPriceSpan.innerText = (1 / currentRate).toFixed(6) + " BNB";
      stageEndTimestamp = Math.floor(Date.now() / 1000) + 3600 * 24;
      updateCountdown();
      totalSupplySpan.innerText = "1,000,000,000 $BULL";
      progressPercent.innerText = "12.5%";
      progressBarFill.style.width = "12.5%";
    }
  }

  function estimateTokens() {
    let val = parseFloat(bnbAmountInput.value);
    if (isNaN(val) || val <= 0) {
      tokenEstimate.innerText = "Enter BNB amount to see estimated $BULL tokens";
      return;
    }
    let estimated = val * currentRate;
    tokenEstimate.innerText = `You will receive approx. ${estimated.toFixed(2)} $BULL`;
  }

  // ==================== 连接 / 断开（AppKit） ====================
  async function connectWallet() {
    try {
      showNotification("Connecting...", "Opening wallet selector", false);
      modal.open({ view: "Connect", namespace: "eip155" });
    } catch (e) {
      console.error(e);
      showNotification("Connection Failed", e?.message || String(e), true);
    }
  }

  async function disconnectWallet() {
    try {
      modal.adapter?.connectionControllerClient?.disconnect();
    } catch (e) {
      console.warn(e);
    } finally {
      window.location.reload();
    }
  }

  // AppKit：provider 变化（连接成功/换钱包/断开）统一在这里接管
  modal.subscribeProviders(async (state) => {
    const eip155Provider = state?.["eip155"];
    if (!eip155Provider) return;

    try {
      provider = new ethers.providers.Web3Provider(eip155Provider);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      connectBtn.innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
      disconnectBtn.style.display = "inline-block";
      buyButton.disabled = false;
      buyButton.innerText = "Buy $BULL";
      claimButton.style.display = "block";
      dashboardNotice.style.display = "none";
      dashboardGrid.style.display = "grid";
      referralBox.style.display = "block";
      stakingCard.style.display = "block";

      // 保留你原逻辑，但更合理：带上 pathname（/BullForge/）
      referralLink.value = `${window.location.origin}${window.location.pathname}?ref=${userAddress}`;

      await refreshContractData();

      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(updateCountdown, 1000);

      showNotification("Connected", "Wallet connected successfully", false);
    } catch (e) {
      console.error(e);
      showNotification("Connection Failed", e?.message || String(e), true);
    }
  });

  // ==================== 交易（保持你原逻辑） ====================
  async function buyTokens() {
    if (!signer || !contract) return;

    let amount = parseFloat(bnbAmountInput.value);
    if (isNaN(amount) || amount <= 0) {
      showNotification("Invalid amount", "Enter a positive BNB amount", true);
      return;
    }

    let slippage = parseFloat(slippageInput.value) / 100;
    let minTokensOut = Math.floor(amount * currentRate * (1 - slippage));
    let referrer = referrerInput.value.trim() || "0x0000000000000000000000000000000000000000";

    try {
      let tx = await contract.buyTokens(referrer, minTokensOut, {
        value: ethers.utils.parseEther(amount.toString())
      });
      showNotification("Purchase Submitted", `Tx: ${tx.hash}`, false);
      await tx.wait();
      showNotification("Success", "You bought $BULL tokens!", false);
      refreshContractData();
    } catch (e) {
      showNotification("Transaction Failed", e?.message || String(e), true);
    }
  }

  async function claimTokens() {
    if (!signer || !contract) return;

    try {
      let tx = await contract.claimTokens();
      showNotification("Claim Submitted", `Tx: ${tx.hash}`, false);
      await tx.wait();
      showNotification("Success", "Tokens claimed!", false);
      refreshContractData();
    } catch (e) {
      showNotification("Claim Failed", e?.message || String(e), true);
    }
  }

  // ==================== 事件绑定 ====================
  bnbAmountInput.addEventListener("input", estimateTokens);

  copyBtn.addEventListener("click", () => {
    referralLink.select();
    document.execCommand("copy");
    showNotification("Copied!", "Referral link copied to clipboard", false);
  });

  connectBtn.addEventListener("click", connectWallet);
  disconnectBtn.addEventListener("click", disconnectWallet);
  buyButton.addEventListener("click", buyTokens);
  claimButton.addEventListener("click", claimTokens);

  // FAQ 折叠（你原来 HTML 有，但没写 JS，这里顺手补上，不影响）
  document.querySelectorAll(".faq-question").forEach((q) => {
    q.addEventListener("click", () => {
      const ans = q.nextElementSibling;
      if (!ans) return;
      ans.style.display = ans.style.display === "block" ? "none" : "block";
    });
  });

  // 首次加载：未连接也先读链展示数据
  refreshContractData();
</script>
